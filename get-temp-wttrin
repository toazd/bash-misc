#!/usr/bin/env bash
#
# USAGE:
#   ./get-temp-wttrin <location> <optional unit: [cC]|[fF]>
#
# NOTES:
#   https://wttr.in/:help
#   https://github.com/chubin/wttr.in/blob/master/README.md
#
#   Supported location types:
#     /paris                  # city name
#     /~Eiffel+tower          # any location (+ for spaces)
#     /Москва                 # Unicode name of any location in any language
#     /muc                    # airport code (3 letters)
#     /@stackoverflow.com     # domain name
#     /94107                  # area codes
#     /-78.46,106.79          # GPS coordinates

location=${1:-'Paris'}
req_unit=${2:-'mM'} # Default: Celcius
degrees='°'
sign=''
nocloud='盛'
cloud=''
rain=''
snow=''
storm=''
temp_low=10
temp_high=27
lotempicon=''
midtempicon=''
hitempicon=''

case ${req_unit,,} in
    (c*|'') req_unit='mM' ;;
    (f*) req_unit='u' ;;
    (*) req_unit='mM' ;;
esac

while IFS= read -r curl_response || [ -n "$curl_response" ]
do
    curl_response=${curl_response//[[:space:]]}
    curr_weath=${curl_response%'|'*}
    unit=${curl_response#*'°'}
    curr_temp=${curl_response%'°'*}
    [[ $curr_temp = *'-'* ]] && sign='-'
    curr_temp=${curr_temp#*[-+]}

    if [ -n "$curr_temp" ]
    then
        if [ "$curr_temp" -lt "$temp_low" ]
        then
            printf '%s %+5s' "$curr_weath" "${sign}${curr_temp}${degrees}${unit}"
        elif [ "$curr_temp" -ge "$temp_low" ] && [ "$curr_temp" -le "$temp_high" ]
        then
            printf '%s %+5s' "$curr_weath" "${sign}${curr_temp}${degrees}${unit}"
        elif [ "$curr_temp" -gt "$temp_high" ]
        then
            printf '%s %+5s' "$curr_weath" "${sign}${curr_temp}${degrees}${unit}"
        fi
    else
        printf '%s' "?"
    fi
done <<EOC
$(curl -sL https://wttr.in/"${location}?${req_unit}"0qQTF\&lang=en\&format="%c|%t")
EOC
